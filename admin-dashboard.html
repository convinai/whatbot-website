<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Dashboard | Whatbot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <style>
        :root {
            --green-primary: #25D366;
            --green-dark: #128C7E;
            --sidebar-bg: #1a1a1a;
            --sidebar-hover: #2a2a2a;
            --sidebar-active: #25D366;
            --main-bg: #111111;
            --card-bg: #1e1e1e;
            --card-border: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --text-muted: #666666;
            --success: #25D366;
            --warning: #f59e0b;
            --error: #ef4444;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background: var(--main-bg);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            padding: 1.25rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: var(--green-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-logo svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .sidebar-title span {
            color: var(--text-secondary);
            font-weight: 400;
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
        }

        .nav-section-title {
            padding: 0.5rem 1rem;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin: 0.125rem 0.5rem;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.15s;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--sidebar-active);
            color: var(--sidebar-bg);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--card-border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--green-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--sidebar-bg);
        }

        .user-email {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-logout {
            width: 100%;
            padding: 0.625rem;
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-logout:hover {
            background: var(--sidebar-hover);
            color: var(--text-primary);
            border-color: var(--text-muted);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 1.5rem 2rem;
            min-height: 100vh;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-refresh {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-refresh:hover {
            background: var(--sidebar-hover);
        }

        .btn-refresh svg {
            width: 14px;
            height: 14px;
        }

        .last-updated {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 1400px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .stat-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }

        .stat-value.green {
            color: var(--success);
        }

        .stat-value.yellow {
            color: var(--warning);
        }

        .stat-value.red {
            color: var(--error);
        }

        .stat-subtext {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .stats-row-2 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1400px) {
            .stats-row-2 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Users Table */
        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .table-container {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem 1.25rem;
            text-align: left;
        }

        .users-table th {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--card-border);
        }

        .users-table td {
            font-size: 0.9375rem;
            border-bottom: 1px solid var(--card-border);
        }

        .users-table tr:last-child td {
            border-bottom: none;
        }

        .users-table tr:hover td {
            background: rgba(255,255,255,0.02);
        }

        .user-email-cell {
            font-weight: 500;
        }

        .cost-cell {
            color: var(--success);
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
        }

        .status-badge.normal {
            background: rgba(37, 211, 102, 0.15);
            color: var(--success);
        }

        .status-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status-badge.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--main-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--card-border);
            border-top-color: var(--green-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        /* Feedback specific */
        .feedback-count {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .star-rating {
            color: #f59e0b;
            font-size: 1rem;
            letter-spacing: 2px;
        }

        .star-rating .empty {
            color: var(--text-muted);
        }

        /* Mobile Sidebar */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            .stats-grid,
            .stats-row-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <svg viewBox="0 0 24 24" fill="white">
                    <path d="M12 2C6.5 2 2 6 2 11c0 2.5 1 4.8 2.8 6.5V22l4.2-2.3c1 .3 2 .4 3 .4 5.5 0 10-4 10-9s-4.5-9-10-9z"/>
                </svg>
            </div>
            <div class="sidebar-title">Whatbot <span>Admin</span></div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section-title">Overview</div>
            <a href="#analytics" class="nav-item active" data-page="analytics">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Analytics
            </a>
            <a href="#feedback" class="nav-item" data-page="feedback">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Feedback
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">A</div>
                <span class="user-email" id="user-email">admin@whatbot.com</span>
            </div>
            <button class="btn-logout" id="logout-btn">Logout</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Analytics Page -->
        <div id="page-analytics">
            <div class="page-header">
                <h1 class="page-title">Analytics</h1>
                <div class="header-actions">
                    <button class="btn-refresh" id="refresh-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                        Refresh
                    </button>
                    <span class="last-updated">Updated <span id="last-updated">--:--:--</span></span>
                </div>
            </div>

            <!-- Stats Row 1 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Requests</div>
                    <div class="stat-value" id="stat-total-requests">0</div>
                    <div class="stat-subtext">All time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Today's Requests</div>
                    <div class="stat-value" id="stat-today-requests">0</div>
                    <div class="stat-subtext" id="stat-today-date">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Users</div>
                    <div class="stat-value" id="stat-active-users">0</div>
                    <div class="stat-subtext">This month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Cost</div>
                    <div class="stat-value green" id="stat-total-cost">$0.00</div>
                    <div class="stat-subtext">This month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Latency</div>
                    <div class="stat-value" id="stat-avg-latency">0ms</div>
                    <div class="stat-subtext">Response time</div>
                </div>
            </div>

            <!-- Stats Row 2 -->
            <div class="stats-row-2">
                <div class="stat-card">
                    <div class="stat-label">Error Rate</div>
                    <div class="stat-value" id="stat-error-rate">0.0%</div>
                    <div class="stat-subtext">Failed requests</div>
                </div>
            </div>

            <!-- Users Table -->
            <h2 class="section-title">User Usage This Month</h2>
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Summaries</th>
                            <th>Input Tokens</th>
                            <th>Output Tokens</th>
                            <th>Cost</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                        <tr>
                            <td colspan="6" class="empty-state">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Feedback Page (hidden by default) -->
        <div id="page-feedback" class="hidden">
            <div class="page-header">
                <h1 class="page-title">User Feedback</h1>
                <div class="header-actions">
                    <span class="feedback-count"><span id="feedback-total">0</span> total</span>
                </div>
            </div>
            <div class="table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Rating</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="feedback-tbody">
                        <tr>
                            <td colspan="4" class="empty-state">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const BACKEND_URL = 'https://backend-five-alpha-21.vercel.app';

        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('whatbot_admin_token');

            if (!token) {
                window.location.href = '/shash';
                return null;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!data.success || !data.valid) {
                    localStorage.removeItem('whatbot_admin_token');
                    localStorage.removeItem('whatbot_admin_user');
                    window.location.href = '/shash';
                    return null;
                }

                return token;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/shash';
                return null;
            }
        }

        // Format numbers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Format cost
        function formatCost(cents) {
            return '$' + (cents / 100).toFixed(2);
        }

        // Get status based on cost/usage
        function getStatus(user) {
            const cost = user.monthlyCostCents || 0;
            if (cost > 1000) return { label: 'High', class: 'danger' };
            if (cost > 100) return { label: 'Warning', class: 'warning' };
            return { label: 'Normal', class: 'normal' };
        }

        // Update last updated time
        function updateLastUpdated() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('last-updated').textContent = time;
        }

        // Fetch and display analytics data
        async function fetchAnalytics(token) {
            try {
                const [statsResponse, usersResponse] = await Promise.all([
                    fetch(`${BACKEND_URL}/api/stats`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${BACKEND_URL}/api/stats/users`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const statsData = await statsResponse.json();
                const usersData = await usersResponse.json();

                // Update stats cards
                if (statsData.success && statsData.data) {
                    const stats = statsData.data;
                    document.getElementById('stat-total-requests').textContent = stats.totalRequests || 0;
                    document.getElementById('stat-today-requests').textContent = stats.todayRequests || 0;
                    document.getElementById('stat-today-date').textContent = stats.date || new Date().toISOString().split('T')[0];
                    document.getElementById('stat-avg-latency').textContent = stats.avgLatencyMs ? Math.round(stats.avgLatencyMs) + 'ms' : '0ms';

                    // Calculate error rate
                    const errorRate = stats.totalRequests > 0
                        ? ((stats.errors || 0) / stats.totalRequests * 100).toFixed(1)
                        : '0.0';
                    document.getElementById('stat-error-rate').textContent = errorRate + '%';

                    // Color error rate based on value
                    const errorRateEl = document.getElementById('stat-error-rate');
                    if (parseFloat(errorRate) > 10) {
                        errorRateEl.classList.add('red');
                    } else if (parseFloat(errorRate) > 5) {
                        errorRateEl.classList.add('yellow');
                    }
                }

                // Update users table and calculate totals
                if (usersData.success && usersData.data?.users) {
                    const users = usersData.data.users;

                    // Count active users and total cost
                    const activeUsers = users.filter(u => u.monthlyRequests > 0).length;
                    const totalCost = users.reduce((sum, u) => sum + (u.monthlyCostCents || 0), 0);

                    document.getElementById('stat-active-users').textContent = activeUsers;
                    document.getElementById('stat-total-cost').textContent = formatCost(totalCost);

                    // Populate users table
                    const tbody = document.getElementById('users-tbody');
                    if (users.length > 0) {
                        tbody.innerHTML = users.map(user => {
                            const status = getStatus(user);
                            return `
                                <tr>
                                    <td class="user-email-cell">${user.userId || 'Unknown'}</td>
                                    <td>${user.monthlyRequests || 0}</td>
                                    <td>${formatNumber(user.monthlyInputTokens || 0)}</td>
                                    <td>${formatNumber(user.monthlyOutputTokens || 0)}</td>
                                    <td class="cost-cell">${formatCost(user.monthlyCostCents || 0)}</td>
                                    <td><span class="status-badge ${status.class}">${status.label}</span></td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users yet</td></tr>';
                    }
                }

                updateLastUpdated();
            } catch (error) {
                console.error('Failed to fetch analytics:', error);
            }
        }

        // Generate star rating HTML
        function renderStars(rating) {
            const filled = rating || 0;
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += i <= filled ? 'â˜…' : '<span class="empty">â˜…</span>';
            }
            return `<span class="star-rating">${stars}</span>`;
        }

        // Format date for feedback
        function formatFeedbackDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            }) + ', ' + date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Fetch feedback
        async function fetchFeedback(token) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/feedback/list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                const tbody = document.getElementById('feedback-tbody');
                const totalEl = document.getElementById('feedback-total');

                console.log('Feedback response:', data);

                // API returns { success, data: { feedback: [...], total, limit, offset } }
                if (data.success && data.data?.feedback?.length > 0) {
                    totalEl.textContent = data.data.total || data.data.feedback.length;
                    tbody.innerHTML = data.data.feedback.map(item => `
                        <tr>
                            <td>${formatFeedbackDate(item.createdAt)}</td>
                            <td class="user-email-cell">${item.userId || item.email || 'Anonymous'}</td>
                            <td>${renderStars(item.rating)}</td>
                            <td>${item.feedback || item.message || ''}</td>
                        </tr>
                    `).join('');
                } else {
                    totalEl.textContent = '0';
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No feedback yet</td></tr>';
                }
            } catch (error) {
                console.error('Failed to fetch feedback:', error);
                document.getElementById('feedback-tbody').innerHTML =
                    '<tr><td colspan="4" class="empty-state">Failed to load feedback</td></tr>';
            }
        }

        // Page navigation
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const pages = {
                analytics: document.getElementById('page-analytics'),
                feedback: document.getElementById('page-feedback')
            };

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;

                    // Update active nav
                    navItems.forEach(n => n.classList.remove('active'));
                    item.classList.add('active');

                    // Show/hide pages
                    Object.keys(pages).forEach(key => {
                        pages[key].classList.toggle('hidden', key !== page);
                    });

                    // Fetch data for feedback page
                    if (page === 'feedback') {
                        const token = localStorage.getItem('whatbot_admin_token');
                        fetchFeedback(token);
                    }
                });
            });
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('whatbot_admin_token');
            localStorage.removeItem('whatbot_admin_user');
            window.location.href = '/shash';
        });

        // Refresh handler
        document.getElementById('refresh-btn').addEventListener('click', () => {
            const token = localStorage.getItem('whatbot_admin_token');
            if (token) {
                fetchAnalytics(token);
            }
        });

        // Initialize
        async function init() {
            const token = await checkAuth();

            if (token) {
                // Show user info
                const user = JSON.parse(localStorage.getItem('whatbot_admin_user') || '{}');
                const email = user.email || 'admin@whatbot.com';
                document.getElementById('user-email').textContent = email;
                document.getElementById('user-avatar').textContent = email.charAt(0).toUpperCase();

                // Hide loading overlay
                document.getElementById('loading-overlay').classList.add('hidden');

                // Setup navigation
                setupNavigation();

                // Fetch initial data
                await fetchAnalytics(token);
            }
        }

        init();
    </script>
</body>
</html>
